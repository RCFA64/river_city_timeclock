{% extends "base.html" %}
{% set kiosk_mode = true %}
{% block title %}Kiosk{% endblock %}

{% block content %}
<div class="kioskHeader">
  <div class="kioskBrand">
    <div class="kioskTitle">RCFA Time Clock</div>
    <div class="kioskSub">Kiosk Mode • Touch-friendly • Auto reset</div>
  </div>
  <div class="kioskDate">{{ current_date }}</div>
</div>

<div class="kioskCard">
  <div class="row g-3 align-items-end">
    <div class="col-12 col-md-4">
      <label class="form-label text-secondary kioskLabel">Location</label>
      <select id="location" class="form-select form-select-lg kioskSelect">
        {% for L in locations %}
          <option value="{{L.id}}" {% if L.id==sel %}selected{% endif %}>{{L.name}}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-12 col-md-8">
      <label class="form-label text-secondary kioskLabel">Employee</label>
      <div class="row g-2">
        <div class="col-12 col-lg-7">
          <select id="employee" class="form-select form-select-lg kioskSelect">
            <option value="">Select employee…</option>
            {% for e in emps %}
              <option value="{{e.id}}">{{e.name}}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-12 col-lg-5 d-grid">
          <div id="statusPill" class="kioskStatus bg-secondary">Select an employee</div>
        </div>
      </div>
    </div>
  </div>

  <form id="kioskPunchForm" action="{{ url_for('punch') }}" method="post" class="mt-3">
    <input type="hidden" name="loc" value="{{ sel }}">
    <input type="hidden" name="employee_id" id="employee_id_hidden" value="">
    <input type="hidden" name="kiosk" value="1">

    <div class="row g-3">
      <div class="col-12 col-lg-6 d-grid">
        <button id="btnIn" type="submit" name="type" value="IN" class="btn btn-success kioskBtn">CLOCK IN</button>
      </div>
      <div class="col-12 col-lg-6 d-grid">
        <button id="btnOut" type="submit" name="type" value="OUT" class="btn btn-danger kioskBtn">CLOCK OUT</button>
      </div>
    </div>
  </form>

  <div id="toast" class="kioskToast" style="display:none;"></div>

  <div class="kioskFooter">
    <div class="text-secondary">Tip: Use this on a tablet at the warehouse entrance.</div>
    <a class="btn btn-outline-light btn-sm" href="{{ url_for('index') }}">Exit Kiosk</a>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const locationSel = document.getElementById('location');
  const employeeSel = document.getElementById('employee');
  const employeeHidden = document.getElementById('employee_id_hidden');
  const statusPill = document.getElementById('statusPill');
  const btnIn = document.getElementById('btnIn');
  const btnOut = document.getElementById('btnOut');
  const toast = document.getElementById('toast');

  locationSel.addEventListener('change', () => {
    window.location.search = '?loc=' + locationSel.value;
  });

  employeeSel.addEventListener('change', async () => {
    employeeHidden.value = employeeSel.value || '';
    btnIn.disabled = btnOut.disabled = !employeeSel.value;

    if (!employeeSel.value) {
      statusPill.className = "kioskStatus bg-secondary";
      statusPill.textContent = "Select an employee";
      return;
    }

    try {
      const r = await fetch('/api/employee_status/' + employeeSel.value);
      const j = await r.json();
      if (!j.ok) throw new Error();
      if (j.status === 'IN') {
        statusPill.className = "kioskStatus bg-success";
        statusPill.textContent = "STATUS: CLOCKED IN";
      } else {
        statusPill.className = "kioskStatus bg-danger";
        statusPill.textContent = "STATUS: CLOCKED OUT";
      }
    } catch(e) {
      statusPill.className = "kioskStatus bg-secondary";
      statusPill.textContent = "STATUS: UNKNOWN";
    }
  });

  btnIn.disabled = btnOut.disabled = true;

  // Flash -> kiosk toast + auto reset
  (function showFlashAsToast() {
    const alert = document.querySelector('.alert');
    if (!alert) return;

    toast.textContent = alert.textContent.trim();
    toast.style.display = '';
    setTimeout(() => toast.style.display = 'none', 2500);

    setTimeout(() => {
      employeeSel.value = '';
      employeeHidden.value = '';
      btnIn.disabled = btnOut.disabled = true;
      statusPill.className = "kioskStatus bg-secondary";
      statusPill.textContent = "Select an employee";
    }, 700);
  })();
</script>
{% endblock %}