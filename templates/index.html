{% extends "base.html" %}
{% block title %}Clock{% endblock %}

{% block content %}
<div class="row g-3 align-items-stretch">
  <div class="col-12 col-lg-7">
    <div class="card bg-dark border-light h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between flex-wrap gap-2 align-items-start">
          <div>
            <h2 class="mb-1 fw-bold">Clock In / Out</h2>
            <div class="text-secondary">Fast • touch-friendly • location-aware</div>
          </div>
          <div class="text-end">
            <div class="text-secondary small">Today</div>
            <div class="fw-bold">{{ current_date }}</div>
          </div>
        </div>

        <hr class="border-secondary my-3">

        <!-- Location selector -->
        <form method="get" class="row g-2 align-items-end">
          <div class="col-12 col-md-5">
            <label class="form-label text-secondary">Location</label>
            <select id="location-select" name="loc" class="form-select">
              {% for L in locations %}
                <option value="{{L.id}}" {% if L.id==sel %}selected{% endif %}>{{L.name}}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-12 col-md-7">
            <label class="form-label text-secondary">Find Employee</label>
            <input id="empFilter" class="form-control" placeholder="Type to filter names…" autocomplete="off">
          </div>
        </form>

        <div class="mt-3">
          <!-- Punch form -->
          <form id="punch-form" action="{{ url_for('punch') }}" method="post" class="row g-2 align-items-center">
            <input type="hidden" name="loc" value="{{ sel }}">

            <div class="col-12 col-md-8">
              <label class="form-label text-secondary">Employee</label>
              <select id="employee-select" name="employee_id" class="form-select" required>
                <option value="">Select employee…</option>
                {% for e in emps %}
                  <option value="{{e.id}}" {% if emp and e.id==emp %}selected{% endif %}>{{e.name}}</option>
                {% endfor %}
              </select>
              <div id="empHint" class="text-secondary small mt-1">
                Tip: start typing above to filter the list.
              </div>
            </div>

            <div class="col-12 col-md-4 d-grid gap-2">
              <button type="submit" name="type" value="IN" id="in-btn" class="btn btn-lg btn-success fw-bold py-3">
                CLOCK IN
              </button>
              <button type="submit" name="type" value="OUT" id="out-btn" class="btn btn-lg btn-danger fw-bold py-3 d-none">
                CLOCK OUT
              </button>
            </div>
          </form>
        </div>

        <div class="mt-3">
          <div id="statusPill" class="badge rounded-pill bg-secondary px-3 py-2">
            Select an employee to begin
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Live feed -->
  <div class="col-12 col-lg-5">
    <div class="card bg-dark border-light h-100">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h4 class="mb-0 fw-bold">Recent Activity</h4>
          <span class="text-secondary small">Last 20 punches</span>
        </div>

        <div class="table-responsive mt-3">
          <table id="time-table" class="table table-dark table-striped align-middle mb-0">
            <thead>
              <tr>
                <th style="width:120px;">Time</th>
                <th>Name</th>
                <th style="width:90px;">Type</th>
              </tr>
            </thead>
            <tbody>
              {% for entry in feed %}
                <tr>
                  <td class="text-nowrap">{{ entry.time_str }}</td>
                  <td>{{ entry.employee }}</td>
                  <td>
                    {% if entry.type == 'IN' %}
                      <span class="badge bg-success">IN</span>
                    {% else %}
                      <span class="badge bg-danger">OUT</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
              {% if not feed %}
                <tr><td colspan="3" class="text-center text-secondary py-4">No punches yet</td></tr>
              {% endif %}
            </tbody>
          </table>
        </div>

        <div id="placeholder-msg" class="text-center text-secondary mt-3" style="display:none;">
          Have a wonderful day!
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const locSelect   = document.getElementById('location-select');
  const empSelect   = document.getElementById('employee-select');
  const empFilter   = document.getElementById('empFilter');
  const inBtn       = document.getElementById('in-btn');
  const outBtn      = document.getElementById('out-btn');
  const table       = document.getElementById('time-table');
  const placeholder = document.getElementById('placeholder-msg');
  const statusPill  = document.getElementById('statusPill');

  // Location change -> reload
  locSelect.addEventListener('change', () => {
    const q = '?loc=' + locSelect.value + (empSelect.value ? '&emp=' + empSelect.value : '');
    window.location.search = q;
  });

  // Employee change -> reload so server filters feed by employee
  empSelect.addEventListener('change', () => {
    const q = '?loc=' + locSelect.value + (empSelect.value ? '&emp=' + empSelect.value : '');
    window.location.search = q;
  });

  // Filter employee dropdown locally
  empFilter.addEventListener('input', () => {
    const term = (empFilter.value || '').toLowerCase().trim();
    const opts = empSelect.querySelectorAll('option');
    opts.forEach((o, idx) => {
      if (idx === 0) return;
      const show = o.textContent.toLowerCase().includes(term);
      o.hidden = !show;
    });
  });

  function toggleFeed() {
    if (!empSelect.value) {
      table.style.display       = 'none';
      placeholder.style.display = '';
      inBtn.disabled = outBtn.disabled = true;
      statusPill.className = "badge rounded-pill bg-secondary px-3 py-2";
      statusPill.textContent = "Select an employee to begin";
    } else {
      placeholder.style.display = 'none';
      table.style.display       = '';
    }
  }

  function updateButtons() {
    if (!empSelect.value) return;

    const firstRow = document.querySelector('#time-table tbody tr');
    const lastType = firstRow ? firstRow.querySelector('td:last-child').textContent.trim() : 'OUT';

    if (lastType.includes('IN')) {
      inBtn.classList.add('d-none');
      outBtn.classList.remove('d-none');
      outBtn.disabled = false;
      inBtn.disabled  = true;

      statusPill.className = "badge rounded-pill bg-success px-3 py-2";
      statusPill.textContent = "Status: CLOCKED IN";
    } else {
      outBtn.classList.add('d-none');
      inBtn.classList.remove('d-none');
      inBtn.disabled  = false;
      outBtn.disabled = true;

      statusPill.className = "badge rounded-pill bg-danger px-3 py-2";
      statusPill.textContent = "Status: CLOCKED OUT";
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    toggleFeed();
    updateButtons();
  });
</script>
{% endblock %}