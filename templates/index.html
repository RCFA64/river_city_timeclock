<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- River City custom overrides -->
  <link href="{{ url_for('static', filename='css/custom.css') }}" rel="stylesheet">
  <title>Time Clock</title>
</head>
<body class="p-4">

  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- Login/Logout -->
  {% if current_user.is_authenticated %}
    <a href="{{ url_for('logout') }}" class="btn btn-sm btn-secondary float-end">Logout</a>
  {% else %}
    <a href="{{ url_for('login') }}" class="btn btn-sm btn-primary float-end">Manager Login</a>
  {% endif %}

  <h1>Time Clock</h1>

  <!-- LOCATION SELECT (persisted) -->
  <form id="location-form" class="row g-2 mb-3">
    <div class="col-auto">
      <select id="location-select" class="form-select">
        {% for L in locations %}
          <option value="{{ L.id }}">{{ L.name }}</option>
        {% endfor %}
      </select>
    </div>
  </form>

  <!-- PUNCH FORM -->
  <form id="punch-form" action="{{ url_for('punch') }}" method="post" class="row g-2 mb-4">
    <input type="hidden" id="geo_lat" name="geo_lat">
    <input type="hidden" id="geo_lng" name="geo_lng">
    <input type="hidden" id="loc-field" name="loc" value="{{ sel }}">
    <input type="hidden" id="emp-field" name="emp" value="{{ sel_emp or '' }}">

    <div class="col-auto">
      <select name="employee_id" id="employee-select" class="form-select" required>
        <option value="" disabled selected>Select name</option>
        {% for e in emps %}
          <option value="{{ e.id }}">{{ e.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-auto">
        <button
          type="submit"
          id="toggle-btn"
          class="btn btn-lg {% if next_type=='IN' %}btn-success{% else %}btn-danger{% endif %}"
          style="min-width: 100px;"
        >
          {{ next_type }}
        </button>
      </div>
    </div>
  </form>

  <!-- Current Date -->
  <h2 class="mt-4">{{ current_date }}</h2>

  <!-- Placeholder when no employee selected -->
  <p id="placeholder-msg" class="text-center mt-3" style="display:none;">
    Have a wonderful day!
  </p>

  <!-- Live Feed (shows only selected employee’s punches) -->
  <ul class="list-group" id="live-feed">
    {% for entry in feed %}
      <li class="list-group-item">
        {{ entry.time_str }} – {{ entry.employee }} {{ entry.type }}
      </li>
    {% endfor %}
  </ul>

  <!-- Links -->
  <a href="{{ url_for('report', loc=sel) }}" class="btn btn-link mt-3">View Weekly Report</a>
  {% if current_user.is_manager %}
    <a href="{{ url_for('manage_employees') }}" class="btn btn-link">Manage Employees</a>
  {% endif %}

  <script>
    // 1) GEOLOCATION
    const inBtn  = document.getElementById('btn-in');
    const outBtn = document.getElementById('btn-out');

  navigator.geolocation.getCurrentPosition(
    ({ coords }) => {
      document.getElementById('geo_lat').value = coords.latitude;
      document.getElementById('geo_lng').value = coords.longitude;
      inBtn.disabled = outBtn.disabled = false;    // now you can punch
    },
    err => alert('Could not get your location: ' + err.message)
  );

    // 2) LOCATION PERSISTENCE
    const locSelect = document.getElementById('location-select');
    const locField  = document.getElementById('loc-field');
    const savedLoc  = localStorage.getItem('selectedLoc');
    const qs        = new URLSearchParams(window.location.search);

    // If URL has no loc but we have saved → redirect with it
    if (!qs.has('loc') && savedLoc) {
      window.location.search = '?loc=' + savedLoc;
    }

    // Set the <select> to either URL loc, or saved, or default from server
    const currentLoc = qs.get('loc') || savedLoc || '{{ sel }}';
    locSelect.value = currentLoc;
    locField.value  = currentLoc;
    localStorage.setItem('selectedLoc', currentLoc);

    locSelect.addEventListener('change', () => {
      const v = locSelect.value;
      // changing location resets employee
      localStorage.setItem('selectedLoc', v);
      localStorage.removeItem('selectedEmp');
      window.location.search = '?loc=' + v;
    });

    // 3) EMPLOYEE PERSISTENCE & FEED TOGGLE
    const empSelect   = document.getElementById('employee-select');
    const empField    = document.getElementById('emp-field');
    const liveFeed    = document.getElementById('live-feed');
    const placeholder = document.getElementById('placeholder-msg');
    const savedEmp    = localStorage.getItem('selectedEmp');

    // If URL has emp, use it; else if savedEmp, reload with both
    if (!qs.has('emp') && savedEmp) {
      window.location.search = '?loc=' + currentLoc + '&emp=' + savedEmp;
    }

    // Initialize selection
    const currentEmp = qs.get('emp') || savedEmp || '';
    empSelect.value  = currentEmp;
    empField.value   = currentEmp;
    if (currentEmp) localStorage.setItem('selectedEmp', currentEmp);

    function toggleFeed() {
      if (!empSelect.value) {
        liveFeed.style.display    = 'none';
        placeholder.style.display = '';
      } else {
        placeholder.style.display = 'none';
        liveFeed.style.display    = '';
      }
    }

    empSelect.addEventListener('change', () => {
      const emp = empSelect.value;
      localStorage.setItem('selectedEmp', emp);
      empField.value = emp;
      // preserve loc in URL
      window.location.search = '?loc=' + locSelect.value + '&emp=' + emp;
    });

    // run once on load
    toggleFeed();
  </script>
</body>
</html>
